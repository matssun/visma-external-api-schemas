name: Check Visma Schema Updates

# Run every Monday at midnight UTC
on:
  schedule:
    - cron: '0 0 * * MON'

  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    runs-on: ubuntu-latest
    name: Check for Visma Schema Updates

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for schema updates
        id: check
        run: |
          # Configuration
          SCHEMA_URL="${{ secrets.VISMA_SCHEMA_URL }}"
          CURRENT_SCHEMA="schemas/current/visma_external_api.yaml"
          NEW_SCHEMA=$(mktemp)

          if [ -z "$SCHEMA_URL" ]; then
            echo "‚è≠Ô∏è  Skipping: VISMA_SCHEMA_URL secret not configured"
            echo "configured=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üîç Fetching latest schema from Visma..."
          if curl -sf "$SCHEMA_URL" -o "$NEW_SCHEMA"; then
            echo "‚úÖ Schema fetched successfully"
          else
            echo "‚ùå Failed to fetch schema"
            echo "configured=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üìä Comparing with current schema..."
          if diff -q "$CURRENT_SCHEMA" "$NEW_SCHEMA" > /dev/null 2>&1; then
            echo "‚úÖ No changes detected"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Schema differences detected!"
            echo "changes_detected=true" >> $GITHUB_OUTPUT

            # Show diff summary
            echo "diff_summary<<EOF" >> $GITHUB_OUTPUT
            diff -u "$CURRENT_SCHEMA" "$NEW_SCHEMA" | head -200 >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

          rm -f "$NEW_SCHEMA"

      - name: Create feature branch
        if: steps.check.outputs.changes_detected == 'true'
        id: branch
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="schema-update/visma-${TIMESTAMP}"

          git config user.email "schema-bot@github.com"
          git config user.name "Schema Update Bot"

          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Update schema files
        if: steps.check.outputs.changes_detected == 'true'
        run: |
          # Fetch fresh copy
          SCHEMA_URL="${{ secrets.VISMA_SCHEMA_URL }}"
          NEW_SCHEMA=$(mktemp)

          curl -sf "$SCHEMA_URL" -o "$NEW_SCHEMA"

          # Archive current version
          ARCHIVE_DIR="schemas/archive"
          mkdir -p "$ARCHIVE_DIR"
          ARCHIVE_FILE="${ARCHIVE_DIR}/visma_external_api.yaml.$(date -u +%Y-%m-%d)"

          if [ ! -f "$ARCHIVE_FILE" ]; then
            cp "schemas/current/visma_external_api.yaml" "$ARCHIVE_FILE"
            echo "üì¶ Archived previous version to $ARCHIVE_FILE"
          fi

          # Update current schema
          cp "$NEW_SCHEMA" "schemas/current/visma_external_api.yaml"

          # Update VERSION
          echo "$(date +%Y-%m-%d)" > VERSION

          rm -f "$NEW_SCHEMA"

      - name: Detect breaking changes
        if: steps.check.outputs.changes_detected == 'true'
        id: breaking
        run: |
          # Check for common breaking changes
          BREAKING_CHANGES=""

          if grep -q "removed required" <<< "${{ steps.check.outputs.diff_summary }}"; then
            BREAKING_CHANGES="$BREAKING_CHANGES\n- Removed required fields"
          fi

          if grep -q "type.*changed" <<< "${{ steps.check.outputs.diff_summary }}"; then
            BREAKING_CHANGES="$BREAKING_CHANGES\n- Field type changes detected"
          fi

          if grep -q "enum.*removed" <<< "${{ steps.check.outputs.diff_summary }}"; then
            BREAKING_CHANGES="$BREAKING_CHANGES\n- Removed enum values"
          fi

          if [ -z "$BREAKING_CHANGES" ]; then
            echo "breaking_detected=false" >> $GITHUB_OUTPUT
          else
            echo "breaking_detected=true" >> $GITHUB_OUTPUT
            echo "changes<<EOF" >> $GITHUB_OUTPUT
            echo -e "$BREAKING_CHANGES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.check.outputs.changes_detected == 'true'
        run: |
          git add schemas/ VERSION

          git commit -m "chore: Update Visma schema - $(date +%Y-%m-%d)

- Latest schema from Visma eAccounting API
- Automated update via GitHub Actions
- Review for breaking changes before merging

Generated by: Schema Update Bot"

      - name: Push branch and create PR
        if: steps.check.outputs.changes_detected == 'true'
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"

          echo "üì§ Pushing branch: $BRANCH_NAME"
          git push origin "$BRANCH_NAME"

          # Prepare PR body
          PR_BODY="## üîÑ Visma Schema Update

**Automated schema update detected**

### Changes
\`\`\`
${{ steps.check.outputs.diff_summary }}
\`\`\`

### Review Checklist
- [ ] Review diff for expected changes
- [ ] Check SCHEMA_CHANGELOG.md for details"

          if [ "${{ steps.breaking.outputs.breaking_detected }}" = "true" ]; then
            PR_BODY="$PR_BODY

### ‚ö†Ô∏è Breaking Changes Detected
${{ steps.breaking.outputs.changes }}

**These changes may require action in the main codebase!**"
          fi

          PR_BODY="$PR_BODY

### Next Steps
1. Review this PR for schema changes
2. Test schema compatibility
3. Merge when ready
4. Update submodule in main repository: \`git submodule update --remote\`
5. Regenerate DTOs in main repo

---
*This PR was automatically created by the Schema Update Bot*"

          # Create PR using GitHub CLI
          gh pr create \
            --title "üîÑ Visma Schema Update - $(date +%Y-%m-%d)" \
            --body "$PR_BODY" \
            --label "schema-update" \
            $([ "${{ steps.breaking.outputs.breaking_detected }}" = "true" ] && echo "--label 'breaking-change'") \
            --assignee "${{ github.repository_owner }}"

      - name: Notify if no changes
        if: steps.check.outputs.changes_detected == 'false'
        run: |
          echo "‚úÖ Schema check complete: No updates available"

      - name: Notify if not configured
        if: steps.check.outputs.configured == 'false'
        run: |
          echo "‚è≠Ô∏è  Schema check skipped: VISMA_SCHEMA_URL secret not configured"
          echo ""
          echo "To enable automatic schema updates:"
          echo "1. Add GitHub secret 'VISMA_SCHEMA_URL' with Visma API endpoint"
          echo "2. Make sure the endpoint returns the OpenAPI spec"
